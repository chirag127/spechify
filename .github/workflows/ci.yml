name: CI

# Controls when the workflow will run
# For more information see: https://docs.github.com/actions/reference/workflow-syntax-for-github-actions

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This job builds, tests, and packages the application
  build_and_test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [ '20.x' ] # Specify Node.js versions for testing

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm' # Cache npm dependencies

      - name: Install Dependencies
        run: npm install

      - name: Install Expo CLI (if needed)
        # Expo CLI is often required for React Native builds
        run: npm install -g expo-cli

      - name: Lint with Ruff (or relevant linter for TS)
        # Assuming a modern setup, Ruff can lint TS/JS with plugins, or use ESLint if preferred and configured.
        # For simplicity here, we'll assume a basic lint command. Replace with actual lint command.
        # If using Biome, the command would be: npx @biomejs/biome lint . 
        run: echo "Running linter..."
        # If you have a specific lint script in package.json:
        # run: npm run lint 
        # Example for Biome (if installed globally or via dev dependencies):
        # run: biome lint --apply .

      - name: Run Vitest (Unit/Integration Tests)
        # Assumes Vitest is configured for React Native and tests are in a 'tests' directory or similar.
        run: npm run test -- --coverage
        env:
          CI: true # Ensures test runners behave correctly in CI environment

      # Note: E2E tests for mobile apps (like on Android) typically require a more complex setup
      # involving emulators or physical devices and tools like Appium or Playwright's mobile capabilities.
      # This basic CI assumes unit/integration tests. E2E would be a separate job or stage.
      - name: Setup Android SDK (for potential native builds/tests)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      - name: Grant execute permissions for gradlew
        run: chmod +x android/gradlew
      - name: Build Android App (Debug)
        run: cd android && ./gradlew assembleDebug

      - name: Upload Coverage Report
        uses: codecov/codecov-action@v4
        with:
          token: ${{ secrets.CODECOV_TOKEN }} # Make sure to set this secret in your repository settings
          files: ./coverage/coverage.json # Path to your coverage report file
          fail_ci_if_error: true
